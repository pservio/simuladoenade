<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Questões Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a versão de compatibilidade para garantir que o 'firebase' seja definido globalmente -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .message-box {
            animation: fadeInOut 5s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased text-gray-800 dark:bg-gray-900 dark:text-gray-200 p-4 sm:p-6">
    <div id="root"></div>

    <script>
        // Ícones SVG para substituir react-icons/fa
        const getFaSaveIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-4 h-4"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>`;
        const getFaPlusIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" class="w-4 h-4"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>`;
        const getFaTimesIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" class="w-4 h-4"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>`;
        const getFaSpinnerIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-4 h-4 animate-spin"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48c0-26.51 21.49-48 48-48s48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48c0-26.51-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48c0-26.51-21.49-48-48-48zm-416 48c0-26.51-21.49-48-48-48s-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48zm128-208c0-26.51-21.49-48-48-48s-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48zm288 0c0-26.51-21.49-48-48-48s-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48zm-128 416c0-26.51-21.49-48-48-48s-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48zm-128-208c0-26.51-21.49-48-48-48s-48 21.49-48 48s21.49 48 48 48s48-21.49 48-48z"/></svg>`;
        const getFaChevronDownIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" class="w-4 h-4"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 282.723l154.745-152.229c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg>`;
        const getFaCheckCircleIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-4 h-4"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L225 353c-9.4 9.4-24.6 9.4-33.9 0l-80-80c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l63.1 63.1L335.1 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg>`;
        const getFaExclamationCircleIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-4 h-4"><path d="M256 32c142.1 0 256 113.9 256 256S398.1 544 256 544 0 429.1 0 287.9 113.9 32 256 32zM232 152c0-13.3 10.7-24 24-24s24 10.7 24 24V296c0 13.3-10.7 24-24 24s-24-10.7-24-24V152zm24 336c-19.8 0-36-16.2-36-36s16.2-36 36-36s36 16.2 36 36s-16.2 36-36 36z"/></svg>`;

        // Objeto de configuração do Firebase (suas credenciais)
        const firebaseConfig = {
            apiKey: "AIzaSyB01kuwXz7sTM2_i4038PvpOZALOIw_Mvo",
            authDomain: "desafio-enade-27d04.firebaseapp.com",
            projectId: "desafio-enade-27d04",
            storageBucket: "desafio-enade-27d04.firebasestorage.app",
            messagingSenderId: "579771051623",
            appId: "1:579771051623:web:319638e0ee6c6833356ec2"
        };
        
        // Inicializar Firebase
        let app;
        let db;
        let auth;
        
        // Variáveis de estado
        let questions = [];
        let selectedQuestion = null;
        let editedText = '';
        let loading = false;
        let message = { text: '', type: '' };
        let showModal = false;
        let newQuestionText = '';
        let expanded = false;

        // Função para renderizar a UI
        const render = () => {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-6">
                    <!-- Painel da Esquerda (Lista de Questões) -->
                    <div class="md:w-1/3 w-full bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col h-full overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Editor de Questões</h1>
                            <button id="add-question-btn" class="p-2 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-md transition-transform transform hover:scale-110" title="Adicionar Nova Questão">
                                ${getFaPlusIcon()}
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-2 -mr-2">
                            ${questions.length === 0 ? `
                                <p class="text-gray-500 dark:text-gray-400">Nenhuma questão encontrada.</p>
                            ` : questions.map(q => `
                                <div class="question-item p-4 mb-3 rounded-xl cursor-pointer transition-all duration-300 transform ${selectedQuestion && selectedQuestion.id === q.id ? 'bg-indigo-100 dark:bg-indigo-900 ring-2 ring-indigo-500 scale-[1.02]' : 'bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600'}" data-id="${q.id}">
                                    <p class="font-semibold text-sm truncate">${q.enunciado || 'Questão sem enunciado'}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ID: ${q.id}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Painel da Direita (Editor) -->
                    <div class="md:w-2/3 w-full bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        ${selectedQuestion ? `
                            <div class="flex flex-col h-full">
                                <div class="flex justify-between items-center mb-4 border-b pb-4 border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">
                                        Editar Questão
                                    </h2>
                                    <div class="flex items-center space-x-2">
                                        ${loading ? `<div class="text-lg text-indigo-500" title="Salvando...">${getFaSpinnerIcon()}</div>` : ''}
                                        <button id="save-btn" class="p-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full shadow-md transition-transform transform hover:scale-110" title="Salvar Alterações" ${loading ? 'disabled' : ''}>
                                            ${getFaSaveIcon()}
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">ID: ${selectedQuestion.id}</p>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Ativo: ${selectedQuestion.ativo ? 'Sim' : 'Não'}</p>
                                <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">
                                    Enunciado
                                </label>
                                <textarea id="enunciado-textarea" class="w-full h-auto flex-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4 resize-none transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">${editedText}</textarea>
                                <div class="transition-all duration-500 overflow-hidden ${expanded ? 'max-h-96' : 'max-h-0'}">
                                    <div class="flex flex-col">
                                        <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">
                                            Explicação
                                        </label>
                                        <textarea class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4 resize-none" readonly rows="5">${selectedQuestion.explicacao || ''}</textarea>
                                    </div>
                                </div>
                                <button id="expand-btn" class="w-full text-indigo-500 hover:text-indigo-600 transition-colors duration-200 mt-2 flex items-center justify-center space-x-2">
                                    <span>${expanded ? 'Ocultar Detalhes' : 'Ver Mais Detalhes'}</span>
                                    ${getFaChevronDownIcon()}
                                </button>
                            </div>
                        ` : `
                            <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                                <p class="text-xl text-center">Selecione uma questão na lista à esquerda para começar a editar.</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Modal para adicionar nova questão -->
                ${showModal ? `
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Adicionar Nova Questão</h3>
                                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                                    ${getFaTimesIcon()}
                                </button>
                            </div>
                            <textarea id="new-question-textarea" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4 resize-none mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Digite o texto do enunciado para a nova questão..." rows="6">${newQuestionText}</textarea>
                            <button id="add-question-submit-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-full transition-all duration-300 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                ${loading ? `<div class="animate-spin mx-auto">${getFaSpinnerIcon()}</div>` : 'Adicionar Questão'}
                            </button>
                        </div>
                    </div>
                ` : ''}

                <!-- Caixa de mensagem de status -->
                ${message.text ? `
                    <div id="message-box" class="message-box fixed bottom-4 right-4 p-4 rounded-lg shadow-xl transition-all duration-500 transform ${message.type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white font-semibold flex items-center space-x-2">
                        ${message.type === 'success' ? getFaCheckCircleIcon() : getFaExclamationCircleIcon()}
                        <span>${message.text}</span>
                    </div>
                ` : ''}
            `;

            // Adicionar eventos após a renderização
            attachEvents();
        };

        const attachEvents = () => {
            document.querySelectorAll('.question-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    const question = questions.find(q => q.id === id);
                    if (question) {
                        selectedQuestion = question;
                        editedText = question.enunciado;
                        expanded = true;
                        render();
                    }
                });
            });

            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', handleSave);
            }

            const enunciadoTextarea = document.getElementById('enunciado-textarea');
            if (enunciadoTextarea) {
                enunciadoTextarea.addEventListener('input', (e) => {
                    editedText = e.target.value;
                });
            }

            const expandBtn = document.getElementById('expand-btn');
            if (expandBtn) {
                expandBtn.addEventListener('click', () => {
                    expanded = !expanded;
                    render();
                });
            }

            const addQuestionBtn = document.getElementById('add-question-btn');
            if (addQuestionBtn) {
                addQuestionBtn.addEventListener('click', () => {
                    showModal = true;
                    newQuestionText = '';
                    render();
                });
            }
            
            const closeModalBtn = document.getElementById('close-modal-btn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    showModal = false;
                    render();
                });
            }

            const newQuestionTextarea = document.getElementById('new-question-textarea');
            if (newQuestionTextarea) {
                newQuestionTextarea.addEventListener('input', (e) => {
                    newQuestionText = e.target.value;
                });
            }

            const addQuestionSubmitBtn = document.getElementById('add-question-submit-btn');
            if (addQuestionSubmitBtn) {
                addQuestionSubmitBtn.addEventListener('click', handleAddQuestion);
            }
        };

        // Função para exibir mensagens
        const showMessage = (text, type = 'success') => {
            message = { text, type };
            render();
            setTimeout(() => {
                message = { text: '', type: '' };
                render();
            }, 5000);
        };

        // Funções de manipulação do banco de dados
        const handleSave = async () => {
            if (!selectedQuestion) {
                showMessage('Nenhuma questão selecionada para salvar.', 'error');
                return;
            }
            loading = true;
            render();
            try {
                const questionDocRef = db.collection('perguntas').doc(selectedQuestion.id);
                await questionDocRef.update({
                    enunciado: editedText
                });
                showMessage('Questão salva com sucesso!', 'success');
            } catch (e) {
                console.error("Error updating document:", e);
                showMessage('Erro ao salvar a questão. Verifique o console para mais detalhes.', 'error');
            } finally {
                loading = false;
                render();
            }
        };

        const handleAddQuestion = async () => {
            if (!newQuestionText.trim()) {
                showMessage('O texto da nova questão não pode estar vazio.', 'error');
                return;
            }
            loading = true;
            render();
            try {
                const questionsCollectionRef = db.collection('perguntas');
                await questionsCollectionRef.add({
                    enunciado: newQuestionText,
                    ativo: true,
                });
                newQuestionText = '';
                showModal = false;
                showMessage('Nova questão adicionada com sucesso!', 'success');
            } catch (e) {
                console.error("Error adding new document:", e);
                showMessage('Erro ao adicionar a nova questão.', 'error');
            } finally {
                loading = false;
                render();
            }
        };

        // Autenticação e listener do Firestore
        const initializeAndRun = async () => {
            try {
                // Initialize Firebase
                app = firebase.initializeApp(firebaseConfig);
                db = app.firestore();
                auth = app.auth();
                
                // Removida a chamada de autenticação anônima para evitar o erro 'auth/admin-restricted-operation'
                db.collection('perguntas').onSnapshot(snapshot => {
                    questions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    if (selectedQuestion) {
                        const updatedQuestion = questions.find(q => q.id === selectedQuestion.id);
                        if (updatedQuestion) {
                            selectedQuestion = updatedQuestion;
                            editedText = updatedQuestion.enunciado;
                        }
                    }
                    render();
                }, error => {
                    console.error("Error fetching questions:", error);
                    showMessage('Erro ao buscar as questões.', 'error');
                });
            } catch (error) {
                console.error("Error during initialization:", error);
                showMessage('Erro na inicialização. Verifique sua configuração.', 'error');
            }
        };

        window.onload = initializeAndRun;
    </script>
</body>
</html>
