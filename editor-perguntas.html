<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Perguntas - ENADE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; margin: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: #000; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Editor de Perguntas</h1>
            <div id="firebase-status" class="mb-6 p-4 bg-blue-100 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">Status do Firebase:</h3>
                <div id="firebase-info" class="text-sm text-blue-700">Verificando...</div>
            </div>
            <div id="admin-login" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Login Administrativo</h2>
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="admin-email" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="admin@exemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="admin-password" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="Senha">
                    </div>
                    <button id="admin-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Entrar
                    </button>
                </div>
                <div id="login-status" class="mt-2 text-sm"></div>
            </div>
            <div id="editor-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">Perguntas Cadastradas</h2>
                    <a href="admin-panel-fixed.html" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
                </div>
                <div id="questions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVQ83EIzNpL5ppuxTH1TSUOd0T2G-9KcQ",
            authDomain: "desafioenade2.firebaseapp.com",
            projectId: "desafioenade2",
            storageBucket: "desafioenade2.appspot.com",
            messagingSenderId: "987973574127",
            appId: "1:987973574127:web:4041110632500dbd482a1a",
            measurementId: "G-FD8E45DWKR"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos DOM
        const adminLogin = document.getElementById('admin-login');
        const editorPanel = document.getElementById('editor-panel');
        const adminEmail = document.getElementById('admin-email');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginStatus = document.getElementById('login-status');
        const firebaseInfo = document.getElementById('firebase-info');
        const questionsList = document.getElementById('questions-list');

        let currentAdmin = null;

        // Atualizar status do Firebase
        firebaseInfo.innerHTML = `<div class="text-green-600">✅ Firebase conectado</div><div class="text-xs mt-1">Project ID: ${firebaseConfig.projectId}</div>`;

        // Verificar se o usuário já está logado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                checkIfAdmin(user.uid);
            } else {
                showLoginForm();
            }
        });

        // Login do admin
        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value;
            const password = adminPassword.value;
            if (!email || !password) {
                showMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }
            try {
                adminLoginBtn.disabled = true;
                adminLoginBtn.textContent = 'Entrando...';
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                showMessage(`Erro no login: ${error.message}`, 'error');
            } finally {
                adminLoginBtn.disabled = false;
                adminLoginBtn.textContent = 'Entrar';
            }
        });

        // Verificar se é admin
        async function checkIfAdmin(uid) {
            try {
                const adminQuery = query(collection(db, "admins"), where("uid", "==", uid));
                const adminSnapshot = await getDocs(adminQuery);
                if (!adminSnapshot.empty) {
                    currentAdmin = uid;
                    showEditorPanel();
                    loadQuestions();
                } else {
                    showMessage('Acesso negado. Apenas administradores podem acessar este painel.', 'error');
                    await signOut(auth);
                }
            } catch (error) {
                showMessage(`Erro ao verificar permissões: ${error.message}`, 'error');
            }
        }

        // Mostrar formulário de login
        function showLoginForm() {
            adminLogin.classList.remove('hidden');
            editorPanel.classList.add('hidden');
            currentAdmin = null;
        }

        // Mostrar painel de edição
        function showEditorPanel() {
            adminLogin.classList.add('hidden');
            editorPanel.classList.remove('hidden');
        }

        // Mostrar mensagens
        function showMessage(message, type = 'info') {
            const colors = {
                success: 'text-green-700 bg-green-100 border-green-400',
                error: 'text-red-700 bg-red-100 border-red-400',
                info: 'text-blue-700 bg-blue-100 border-blue-400'
            };
            loginStatus.innerHTML = `<div class="border px-4 py-3 rounded ${colors[type]}">${message}</div>`;
            setTimeout(() => { loginStatus.innerHTML = ''; }, 5000);
        }

        // Carregar perguntas
        async function loadQuestions() {
            questionsList.innerHTML = '<div class="text-gray-500">Carregando perguntas...</div>';
            try {
                const qSnap = await getDocs(collection(db, "perguntas"));
                questionsList.innerHTML = '';
                qSnap.forEach(docSnap => {
                    const q = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'border p-4 rounded-lg shadow-sm bg-white flex flex-col gap-2';
                    div.innerHTML = `
                        <div class="font-semibold text-blue-800 mb-1">ID: ${docSnap.id}</div>
                        <div class="text-lg font-bold text-gray-800 mb-1">${q.enunciado}</div>
                        ${q.imagem_url ? `<img src="${q.imagem_url}" alt="Imagem da Pergunta" class="rounded mb-2 max-h-48 object-contain border">` : ''}
                        <div class="mb-2">
                            <span class="font-semibold">Temas:</span>
                            <input type="text" value="${(q.tema || []).join(', ')}" class="tema-input border rounded px-2 py-1 w-full mt-1" placeholder="Temas separados por vírgula">
                        </div>
                        <button class="save-tema-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-4 rounded self-end">Salvar Temas</button>
                    `;
                    // Salvar temas
                    div.querySelector('.save-tema-btn').onclick = async function() {
                        const novoTema = div.querySelector('.tema-input').value.split(',').map(t=>t.trim()).filter(Boolean);
                        await updateDoc(doc(db, "perguntas", docSnap.id), { tema: novoTema });
                        showMessage('Temas atualizados!', 'success');
                    };
                    questionsList.appendChild(div);
                });
            } catch (error) {
                questionsList.innerHTML = `<div class="text-red-600">Erro ao carregar perguntas: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
