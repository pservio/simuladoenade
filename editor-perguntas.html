<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Perguntas - ENADE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; margin: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: #000; }
        .filter-tag {
            display: inline-block;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 4px 12px;
            margin: 2px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-tag:hover {
            background: #d1d5db;
        }
        .filter-tag.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .alternative {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            border-left: 4px solid #e5e7eb;
        }
        .alternative.correct {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Editor de Perguntas</h1>
            <div id="firebase-status" class="mb-6 p-4 bg-blue-100 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">Status do Firebase:</h3>
                <div id="firebase-info" class="text-sm text-blue-700">Verificando...</div>
            </div>
            <div id="admin-login" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Login Administrativo</h2>
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="admin-email" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="admin@exemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="admin-password" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="Senha">
                    </div>
                    <button id="admin-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Entrar
                    </button>
                </div>
                <div id="login-status" class="mt-2 text-sm"></div>
            </div>
            <div id="editor-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">Perguntas Cadastradas</h2>
                    <a href="admin-panel-fixed.html" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
                </div>
                
                <!-- Sistema de Filtros -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Filtrar por Temas</h3>
                    <div class="flex flex-wrap gap-2 mb-3" id="available-themes">
                        <span class="text-gray-600 text-sm">Carregando temas...</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700">Filtros ativos:</span>
                        <div id="active-filters" class="flex flex-wrap gap-2"></div>
                        <button id="clear-filters" class="text-sm text-red-600 hover:text-red-800 font-medium">Limpar filtros</button>
                    </div>
                </div>
                
                <div id="questions-list" class="space-y-6"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVQ83EIzNpL5ppuxTH1TSUOd0T2G-9KcQ",
            authDomain: "desafioenade2.firebaseapp.com",
            projectId: "desafioenade2",
            storageBucket: "desafioenade2.appspot.com",
            messagingSenderId: "987973574127",
            appId: "1:987973574127:web:4041110632500dbd482a1a",
            measurementId: "G-FD8E45DWKR"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Configurar persistência local para manter sessão
        setPersistence(auth, browserLocalPersistence);

        // Elementos DOM
        const adminLogin = document.getElementById('admin-login');
        const editorPanel = document.getElementById('editor-panel');
        const adminEmail = document.getElementById('admin-email');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginStatus = document.getElementById('login-status');
        const firebaseInfo = document.getElementById('firebase-info');
        const questionsList = document.getElementById('questions-list');
        const availableThemes = document.getElementById('available-themes');
        const activeFilters = document.getElementById('active-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');

        let currentAdmin = null;
        let allQuestions = [];
        let allThemes = new Set();
        let activeFilterThemes = new Set();

        // Atualizar status do Firebase
        firebaseInfo.innerHTML = `<div class="text-green-600">✅ Firebase conectado</div><div class="text-xs mt-1">Project ID: ${firebaseConfig.projectId}</div>`;

        // Verificar se o usuário já está logado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Renovar token automaticamente para evitar expiração
                try {
                    await user.getIdToken(true);
                    console.log('Token renovado automaticamente');
                } catch (error) {
                    console.error('Erro ao renovar token:', error);
                }
                
                checkIfAdmin(user.uid);
            } else {
                showLoginForm();
            }
        });

        // Login do admin
        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value;
            const password = adminPassword.value;
            if (!email || !password) {
                showMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }
            try {
                adminLoginBtn.disabled = true;
                adminLoginBtn.textContent = 'Entrando...';
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                showMessage(`Erro no login: ${error.message}`, 'error');
            } finally {
                adminLoginBtn.disabled = false;
                adminLoginBtn.textContent = 'Entrar';
            }
        });

        // Verificar se é admin
        async function checkIfAdmin(uid) {
            try {
                const adminQuery = query(collection(db, "admins"), where("uid", "==", uid));
                const adminSnapshot = await getDocs(adminQuery);
                if (!adminSnapshot.empty) {
                    currentAdmin = uid;
                    showEditorPanel();
                    loadQuestions();
                } else {
                    showMessage('Acesso negado. Apenas administradores podem acessar este painel.', 'error');
                    await signOut(auth);
                }
            } catch (error) {
                showMessage(`Erro ao verificar permissões: ${error.message}`, 'error');
            }
        }

        // Mostrar formulário de login
        function showLoginForm() {
            adminLogin.classList.remove('hidden');
            editorPanel.classList.add('hidden');
            currentAdmin = null;
        }

        // Mostrar painel de edição
        function showEditorPanel() {
            adminLogin.classList.remove('hidden');
            editorPanel.classList.remove('hidden');
        }

        // Mostrar mensagens
        function showMessage(message, type = 'info') {
            const colors = {
                success: 'text-green-700 bg-green-100 border-green-400',
                error: 'text-red-700 bg-red-100 border-red-400',
                info: 'text-blue-700 bg-blue-100 border-blue-400'
            };
            loginStatus.innerHTML = `<div class="border px-4 py-3 rounded ${colors[type]}">${message}</div>`;
            setTimeout(() => { loginStatus.innerHTML = ''; }, 5000);
        }

        // Carregar perguntas
        async function loadQuestions() {
            questionsList.innerHTML = '<div class="text-gray-500">Carregando perguntas...</div>';
            try {
                const qSnap = await getDocs(collection(db, "perguntas"));
                allQuestions = [];
                allThemes.clear();
                
                qSnap.forEach(docSnap => {
                    const q = docSnap.data();
                    const questionData = {
                        id: docSnap.id,
                        ...q
                    };
                    allQuestions.push(questionData);
                    
                    // Coletar todos os temas
                    if (q.tema && Array.isArray(q.tema)) {
                        q.tema.forEach(tema => {
                            if (tema.trim()) {
                                allThemes.add(tema.trim());
                            }
                        });
                    }
                });
                
                renderThemeFilters();
                renderQuestions();
            } catch (error) {
                questionsList.innerHTML = `<div class="text-red-600">Erro ao carregar perguntas: ${error.message}</div>`;
            }
        }

        // Renderizar filtros de temas
        function renderThemeFilters() {
            availableThemes.innerHTML = '';
            Array.from(allThemes).sort().forEach(tema => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = tema;
                tag.onclick = () => toggleThemeFilter(tema);
                availableThemes.appendChild(tag);
            });
        }

        // Alternar filtro de tema
        function toggleThemeFilter(tema) {
            if (activeFilterThemes.has(tema)) {
                activeFilterThemes.delete(tema);
            } else {
                activeFilterThemes.add(tema);
            }
            renderActiveFilters();
            renderQuestions();
        }

        // Renderizar filtros ativos
        function renderActiveFilters() {
            activeFilters.innerHTML = '';
            Array.from(activeFilterThemes).forEach(tema => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag active';
                tag.textContent = tema;
                tag.onclick = () => toggleThemeFilter(tema);
                activeFilters.appendChild(tag);
            });
        }

        // Limpar filtros
        clearFiltersBtn.onclick = () => {
            activeFilterThemes.clear();
            renderActiveFilters();
            renderQuestions();
        };

        // Renderizar perguntas
        function renderQuestions() {
            questionsList.innerHTML = '';
            
            // Filtrar perguntas
            let filteredQuestions = allQuestions;
            if (activeFilterThemes.size > 0) {
                filteredQuestions = allQuestions.filter(q => {
                    if (!q.tema || !Array.isArray(q.tema)) return false;
                    return Array.from(activeFilterThemes).some(tema => 
                        q.tema.some(qTema => qTema.trim().toLowerCase() === tema.toLowerCase())
                    );
                });
            }
            
            if (filteredQuestions.length === 0) {
                questionsList.innerHTML = '<div class="text-gray-500 text-center py-8">Nenhuma pergunta encontrada com os filtros selecionados.</div>';
                return;
            }
            
            filteredQuestions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'border p-6 rounded-lg shadow-sm bg-white';
                
                // Enunciado
                let html = `
                    <div class="font-semibold text-blue-800 mb-2">ID: ${q.id}</div>
                    <div class="text-lg font-bold text-gray-800 mb-4">${q.enunciado}</div>
                `;
                
                // Imagem se existir
                if (q.imagem_url) {
                    html += `<img src="${q.imagem_url}" alt="Imagem da Pergunta" class="rounded mb-4 max-h-64 object-contain border">`;
                }
                
                // Alternativas - com debug e suporte a diferentes formatos
                console.log('Dados da pergunta:', q);
                let alternativas = [];
                
                // Tentar diferentes formatos de alternativas
                if (q.alternativas && Array.isArray(q.alternativas)) {
                    alternativas = q.alternativas;
                } else if (q.alternativa_a || q.alternativa_b || q.alternativa_c || q.alternativa_d || q.alternativa_e) {
                    // Formato com campos separados
                    if (q.alternativa_a) alternativas.push(q.alternativa_a);
                    if (q.alternativa_b) alternativas.push(q.alternativa_b);
                    if (q.alternativa_c) alternativas.push(q.alternativa_c);
                    if (q.alternativa_d) alternativas.push(q.alternativa_d);
                    if (q.alternativa_e) alternativas.push(q.alternativa_e);
                } else if (q.opcoes && Array.isArray(q.opcoes)) {
                    alternativas = q.opcoes;
                } else if (q.opcao_A || q.opcao_B || q.opcao_C || q.opcao_D || q.opcao_E) {
                    // Formato com opções separadas (maiúsculas)
                    if (q.opcao_A) alternativas.push(q.opcao_A);
                    if (q.opcao_B) alternativas.push(q.opcao_B);
                    if (q.opcao_C) alternativas.push(q.opcao_C);
                    if (q.opcao_D) alternativas.push(q.opcao_D);
                    if (q.opcao_E) alternativas.push(q.opcao_E);
                } else if (q.opcao_a || q.opcao_b || q.opcao_c || q.opcao_d || q.opcao_e) {
                    // Formato com opções separadas (minúsculas)
                    if (q.opcao_a) alternativas.push(q.opcao_a);
                    if (q.opcao_b) alternativas.push(q.opcao_b);
                    if (q.opcao_c) alternativas.push(q.opcao_c);
                    if (q.opcao_d) alternativas.push(q.opcao_d);
                    if (q.opcao_e) alternativas.push(q.opcao_e);
                }
                
                console.log('Alternativas encontradas:', alternativas);
                
                if (alternativas.length > 0) {
                    html += '<div class="mb-4"><h4 class="font-semibold text-gray-700 mb-2">Alternativas:</h4>';
                    alternativas.forEach((alt, index) => {
                        const isCorrect = q.resposta_correta === index || 
                                        q.resposta_correta === String.fromCharCode(65 + index) ||
                                        q.resposta_correta === String.fromCharCode(97 + index);
                        html += `
                            <div class="alternative ${isCorrect ? 'correct' : ''}">
                                <span class="font-medium">${String.fromCharCode(65 + index)})</span> 
                                ${alt}
                                ${isCorrect ? '<span class="text-green-600 font-semibold ml-2">✓ Correta</span>' : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="mb-4 text-yellow-600">⚠️ Nenhuma alternativa encontrada para esta pergunta</div>';
                }
                
                // Temas
                html += `
                    <div class="mb-4">
                        <span class="font-semibold text-gray-700">Temas:</span>
                        <input type="text" value="${(q.tema || []).join(', ')}" class="tema-input border rounded px-3 py-2 w-full mt-2" placeholder="Temas separados por vírgula">
                    </div>
                    <button class="save-tema-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Salvar Temas</button>
                `;
                

                
                div.innerHTML = html;
                
                // Evento para salvar temas
                div.querySelector('.save-tema-btn').onclick = async function() {
                    const novoTema = div.querySelector('.tema-input').value.split(',').map(t=>t.trim()).filter(Boolean);
                    try {
                        await updateDoc(doc(db, "perguntas", q.id), { tema: novoTema });
                        showMessage('Temas atualizados!', 'success');
                        // Recarregar perguntas para atualizar os filtros
                        loadQuestions();
                    } catch (error) {
                        showMessage(`Erro ao atualizar temas: ${error.message}`, 'error');
                    }
                };
                
                questionsList.appendChild(div);
            });
        }
    </script>
</body>
</html>
