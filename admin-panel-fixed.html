<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - ENADE (Corrigido)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; margin: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: #000; }
        .debug-info { background: #f0f0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Painel Administrativo - ENADE (Corrigido)</h1>
            
            <!-- Status do Firebase -->
            <div id="firebase-status" class="mb-6 p-4 bg-blue-100 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">Status do Firebase:</h3>
                <div id="firebase-info" class="text-sm text-blue-700">Verificando...</div>
            </div>

            <!-- Login do Admin -->
            <div id="admin-login" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Login Administrativo</h2>
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="admin-email" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="admin@exemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="admin-password" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="Senha">
                    </div>
                    <button id="admin-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Entrar
                    </button>
                </div>
                <div id="login-status" class="mt-2 text-sm"></div>
            </div>

            <!-- Painel Principal (oculto até login) -->
            <div id="admin-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciamento de Alunos</h2>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        Sair
                    </button>
                </div>

                <!-- Formulário de Cadastro -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Cadastrar Novo Aluno</h3>
                    <form id="student-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                            <input type="text" id="student-name" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="Nome do aluno">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="student-email" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="email@exemplo.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                            <input type="password" id="student-password" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="Senha">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ano de Inscrição</label>
                            <select id="student-year" required class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                                <option value="">Selecione o ano</option>
                                <option value="2012-2017">2012-2017</option>
                                <option value="2018-2019">2018-2019</option>
                                <option value="2020-2024">2020-2024</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="student-status" required class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
                                Cadastrar Aluno
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Alunos -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700">Alunos Cadastrados</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ano</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dados serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Debug Console -->
            <div id="debug-console" class="mt-8 p-4 bg-gray-900 text-green-400 rounded-lg">
                <h3 class="font-semibold mb-2">Debug Console:</h3>
                <div id="debug-output" class="text-xs font-mono max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal">&times;</span>
            <h3 id="modal-title" class="text-lg font-semibold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    Cancelar
                </button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVQ83EIzNpL5ppuxTH1TSUOd0T2G-9KcQ",
            authDomain: "desafioenade2.firebaseapp.com",
            projectId: "desafioenade2",
            storageBucket: "desafioenade2.appspot.com",
            messagingSenderId: "987973574127",
            appId: "1:987973574127:web:4041110632500dbd482a1a",
            measurementId: "G-FD8E45DWKR"
        };

        // Debug function
        function debugLog(message, type = 'info') {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-yellow-400';
            
            debugOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // Inicializar Firebase
        debugLog('Iniciando configuração do Firebase...');
        
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            debugLog('Firebase inicializado com sucesso', 'success');
            
            // Atualizar status do Firebase
            document.getElementById('firebase-info').innerHTML = `
                <div class="text-green-600">✅ Firebase conectado</div>
                <div class="text-xs mt-1">Project ID: ${firebaseConfig.projectId}</div>
            `;
        } catch (error) {
            debugLog(`Erro ao inicializar Firebase: ${error.message}`, 'error');
            document.getElementById('firebase-info').innerHTML = `
                <div class="text-red-600">❌ Erro no Firebase: ${error.message}</div>
            `;
        }

        // Elementos DOM
        const adminLogin = document.getElementById('admin-login');
        const adminPanel = document.getElementById('admin-panel');
        const adminEmail = document.getElementById('admin-email');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginStatus = document.getElementById('login-status');
        const logoutBtn = document.getElementById('logout-btn');
        const studentForm = document.getElementById('student-form');
        const studentsTableBody = document.getElementById('students-table-body');
        const confirmModal = document.getElementById('confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const closeModal = document.getElementById('close-modal');

        let currentAdmin = null;

        // Verificar se o usuário já está logado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                debugLog(`Usuário autenticado: ${user.email}`);
                // Verificar se é admin
                checkIfAdmin(user.uid);
            } else {
                debugLog('Nenhum usuário autenticado');
                showLoginForm();
            }
        });

        // Login do admin
        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value;
            const password = adminPassword.value;

            if (!email || !password) {
                showMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }

            try {
                debugLog(`Tentando login com: ${email}`);
                adminLoginBtn.disabled = true;
                adminLoginBtn.textContent = 'Entrando...';
                
                await signInWithEmailAndPassword(auth, email, password);
                debugLog('Login realizado com sucesso', 'success');
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                debugLog(`Erro no login: ${error.code} - ${error.message}`, 'error');
                showMessage(`Erro no login: ${error.message}`, 'error');
            } finally {
                adminLoginBtn.disabled = false;
                adminLoginBtn.textContent = 'Entrar';
            }
        });

        // Verificar se é admin
        async function checkIfAdmin(uid) {
            try {
                debugLog(`Verificando se ${uid} é admin...`);
                const adminQuery = query(collection(db, "admins"), where("uid", "==", uid));
                const adminSnapshot = await getDocs(adminQuery);
                
                if (!adminSnapshot.empty) {
                    debugLog('Usuário é admin, mostrando painel', 'success');
                    currentAdmin = uid;
                    showAdminPanel();
                    loadStudents();
                } else {
                    debugLog('Usuário não é admin', 'error');
                    showMessage('Acesso negado. Apenas administradores podem acessar este painel.', 'error');
                    await signOut(auth);
                }
            } catch (error) {
                debugLog(`Erro ao verificar permissões: ${error.message}`, 'error');
                showMessage(`Erro ao verificar permissões: ${error.message}`, 'error');
            }
        }

        // Mostrar formulário de login
        function showLoginForm() {
            adminLogin.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            currentAdmin = null;
        }

        // Mostrar painel admin
        function showAdminPanel() {
            adminLogin.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        }

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                debugLog('Logout realizado', 'success');
                showMessage('Logout realizado com sucesso!', 'success');
            } catch (error) {
                debugLog(`Erro no logout: ${error.message}`, 'error');
                showMessage(`Erro no logout: ${error.message}`, 'error');
            }
        });

        // Cadastrar aluno
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('student-name').value;
            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;
            const year = document.getElementById('student-year').value;
            const status = document.getElementById('student-status').value;

            if (!name || !email || !password || !year) {
                showMessage('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }

            try {
                debugLog(`Tentando criar aluno: ${email}`);
                
                // Criar usuário no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                debugLog(`Usuário criado no Auth: ${uid}`, 'success');

                // Salvar dados do aluno no Firestore
                const studentData = {
                    uid: uid,
                    name: name,
                    email: email,
                    year: year,
                    status: status,
                    createdAt: new Date(),
                    createdBy: currentAdmin
                };
                
                debugLog('Salvando dados no Firestore...');
                await addDoc(collection(db, "students"), studentData);
                
                debugLog('Aluno cadastrado com sucesso!', 'success');
                showMessage('Aluno cadastrado com sucesso!', 'success');
                studentForm.reset();
                loadStudents();
                
            } catch (error) {
                debugLog(`Erro ao cadastrar aluno: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = 'Erro ao cadastrar aluno.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email já está em uso.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'A senha é muito fraca (mínimo 6 caracteres).';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Autenticação por email/senha não está habilitada no Firebase.';
                        break;
                    default:
                        errorMessage = `Erro: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
            }
        });

        // Carregar lista de alunos
        async function loadStudents() {
            try {
                debugLog('Carregando lista de alunos...');
                const studentsSnapshot = await getDocs(collection(db, "students"));
                studentsTableBody.innerHTML = '';

                debugLog(`Encontrados ${studentsSnapshot.size} alunos`);
                
                studentsSnapshot.forEach((doc) => {
                    const student = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.year}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${student.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${student.status === 'active' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editStudent('${doc.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                            <button onclick="deleteStudent('${doc.id}', '${student.name}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    studentsTableBody.appendChild(row);
                });
                
                debugLog('Lista de alunos carregada com sucesso', 'success');
            } catch (error) {
                debugLog(`Erro ao carregar alunos: ${error.message}`, 'error');
                showMessage(`Erro ao carregar alunos: ${error.message}`, 'error');
            }
        }

        // Excluir aluno
        window.deleteStudent = async (docId, studentName) => {
            showConfirmModal(
                'Confirmar Exclusão',
                `Tem certeza que deseja excluir o aluno "${studentName}"? Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        debugLog(`Excluindo aluno: ${studentName}`);
                        await deleteDoc(doc(db, "students", docId));
                        debugLog('Aluno excluído com sucesso', 'success');
                        showMessage('Aluno excluído com sucesso!', 'success');
                        loadStudents();
                    } catch (error) {
                        debugLog(`Erro ao excluir aluno: ${error.message}`, 'error');
                        showMessage(`Erro ao excluir aluno: ${error.message}`, 'error');
                    }
                }
            );
        };

        // Editar aluno (placeholder)
        window.editStudent = (docId) => {
            showMessage('Funcionalidade de edição será implementada em breve.', 'info');
        };

        // Modal de confirmação
        function showConfirmModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmModal.style.display = 'flex';
            
            modalConfirm.onclick = () => {
                confirmModal.style.display = 'none';
                onConfirm();
            };
            
            modalCancel.onclick = () => {
                confirmModal.style.display = 'none';
            };
            
            closeModal.onclick = () => {
                confirmModal.style.display = 'none';
            };
        }

        // Mostrar mensagens
        function showMessage(message, type = 'info') {
            const colors = {
                success: 'text-green-700 bg-green-100 border-green-400',
                error: 'text-red-700 bg-red-100 border-red-400',
                info: 'text-blue-700 bg-blue-100 border-blue-400'
            };
            
            loginStatus.innerHTML = `
                <div class="border px-4 py-3 rounded ${colors[type]}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                loginStatus.innerHTML = '';
            }, 5000);
        }

        // Fechar modal ao clicar fora
        window.onclick = (event) => {
            if (event.target === confirmModal) {
                confirmModal.style.display = 'none';
            }
        };

        debugLog('Sistema inicializado e pronto', 'success');
    </script>
</body>
</html> 